# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Architecture Overview

This is an Ansible-based Ubuntu development environment setup system with an interactive whiptail installer. The architecture follows a modular role-based design with comprehensive testing infrastructure.

**Core workflow**: `setup.sh` → Interactive selection → Dynamic Ansible tag generation → Role execution → Post-install guidance

## Essential Commands

### Installation and Testing
```bash
# Interactive installer (main entry point)
./setup.sh

# Non-interactive mode for automation
./setup.sh --non-interactive

# Test mode (dry run)
./setup.sh --test

# Manual Ansible execution
ansible-playbook site.yml --tags homebrew,dev-basic
ansible-playbook site.yml --check  # dry run
ansible-playbook site.yml --syntax-check

# Run comprehensive test suite
./tests/test_runner.sh
./tests/test_runner.sh --role tools  # test specific role
```

### Development Commands
```bash
# Validate all Ansible syntax
find . -name "*.yml" -exec ansible-playbook {} --syntax-check \;

# Test individual roles
ansible-playbook site.yml --tags specific-tag --check

# Run security and integration tests
./tests/test_runner.sh --type security
./tests/test_runner.sh --type integration
```

## Role Architecture

The system uses 5 main Ansible roles with specific responsibilities:

- **`brew`**: Homebrew installation and PATH configuration
- **`dev`**: Core development tools (APT packages, Docker with GPG verification)
- **`tools`**: Modern CLI utilities via Homebrew with async batch installation
- **`preferences`**: Shell configuration and user settings
- **`dotfiles`**: GNU Stow-based configuration management with backup/rollback

### Key Architectural Patterns

**Dynamic Variable Generation**: `setup.sh` creates runtime variables for selective CLI tool installation:
```bash
# Generated in setup.sh based on user selection
install_bat: true
install_fzf: false
```

**Tag-Based Modular Execution**: Each component maps to specific Ansible tags:
- `homebrew`, `dev-basic`, `dev-docker`, `tools-cli`, `tools-git`, `preferences`, `dotfiles`

**Dotfiles Management**: Uses GNU Stow with conflict resolution:
- Organized by application in `dotfiles/` subdirectories
- Automatic backup to `.dotfiles_backup/` before applying
- Rollback capability for failed installations

## Configuration Files

### Primary Configuration
- `group_vars/all.yml`: Global tool lists, user preferences, and system paths
- `site.yml`: Main playbook orchestrating all roles
- `setup.sh`: Interactive installer with input validation and error handling

### Role Structure
Each role follows standard Ansible structure:
```
roles/[role-name]/
├── tasks/main.yml      # Main execution logic
├── vars/main.yml       # Role-specific variables
└── handlers/main.yml   # Event-driven tasks
```

## Adding New Components

### Adding CLI Tools
1. Edit `group_vars/all.yml` → add to appropriate tool lists
2. Update `setup.sh` → modify CLI_TOOLS array and option mapping
3. Modify `roles/tools/tasks/main.yml` → add conditional installation logic

### Adding New Dotfiles
1. Create subdirectory in `dotfiles/` (e.g., `dotfiles/neovim/`)
2. Add configuration files
3. Update `roles/dotfiles/tasks/main.yml` → include new stow package
4. Add to dotfiles list in `group_vars/all.yml`

### Creating New Roles
1. Follow standard Ansible role structure
2. Add to `site.yml` with appropriate tags
3. Update `setup.sh` interactive menu if user-selectable
4. Create corresponding tests in `tests/`

## Testing Infrastructure

The repository includes a comprehensive test runner (`tests/test_runner.sh`) with:

- **Syntax Tests**: Ansible YAML validation
- **Role Tests**: Structure and task validation
- **Integration Tests**: System dependency verification
- **Security Tests**: Permission and sensitive data checks

**Test execution patterns**:
```bash
# Filter by test type
./tests/test_runner.sh --type syntax

# Filter by role
./tests/test_runner.sh --role brew

# Full test suite with detailed logging
./tests/test_runner.sh  # logs to tests/logs/test_TIMESTAMP.log
```

## Important Implementation Details

### Interactive Setup Process
`setup.sh` implements a sophisticated user experience:
1. Prerequisites installation (curl, git, whiptail, ansible)
2. Component selection via whiptail checklist
3. CLI tools sub-menu with individual selection
4. Confirmation dialog with selected components
5. Dynamic Ansible execution with generated tags

### Security Considerations
- Input validation and sanitization in `setup.sh`
- GPG key verification for Docker repository setup
- Proper file permissions and backup mechanisms
- Error handling to prevent partial installations

### Variable Scope and Override
- Global variables in `group_vars/all.yml`
- Role-specific variables in `roles/*/vars/main.yml`
- Runtime variables generated by `setup.sh`
- Environment-specific overrides possible

## Key File Locations

- `group_vars/all.yml`: Central configuration hub - tool definitions, user preferences
- `setup.sh`: Interactive installer with input validation and tag generation
- `site.yml`: Main orchestration playbook
- `dotfiles/`: Application-specific configuration files organized by tool
- `roles/*/tasks/main.yml`: Core implementation logic for each component
- `tests/test_runner.sh`: Comprehensive test orchestration